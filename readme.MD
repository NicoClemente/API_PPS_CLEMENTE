# ğŸ¬ FlixFinder API - Backend

## Proyecto Final de PrÃ¡ctica Profesional Supervisada (PPS)
**Universidad TecnolÃ³gica Nacional - FRBB**  
**Materia:** Laboratorio IV  
**Profesor:** SebastiÃ¡n GaÃ±an  
**Alumno**: NicolÃ¡s Clemente

---

## ğŸ“‹ DescripciÃ³n

API REST desarrollada con Node.js y Express que gestiona pelÃ­culas, series, actores, usuarios, favoritos y reseÃ±as. El sistema implementa:

- âœ… Base de datos PostgreSQL en Neon (nube) para persistencia
- âœ… Operaciones CRUD completas para usuarios, favoritos y reseÃ±as
- âœ… ProtecciÃ³n con API_KEY en todas las rutas `/api`
- âœ… AutenticaciÃ³n JWT para usuarios registrados
- âœ… IntegraciÃ³n con APIs externas (TMDb para pelÃ­culas, series y actores)
- âœ… Sistema de favoritos y reseÃ±as
- âœ… GestiÃ³n completa de usuarios con hashing de contraseÃ±as (bcrypt)
- âœ… CORS habilitado para frontend (Flutter Web)

---

## ğŸš€ InstalaciÃ³n

### Requisitos previos
- Node.js v16 o superior
- npm o yarn
- Cuenta en [Neon](https://neon.tech) para base de datos PostgreSQL

### Pasos de instalaciÃ³n

1. **Clonar el repositorio**
```bash
git clone [URL_DEL_REPO_BACKEND]
cd API_PPS_CLEMENTE
```

2. **Instalar dependencias**
```bash
npm install
```

3. **Configurar base de datos en Neon**
   - Crear una cuenta en Neon
   - Crear un nuevo proyecto de base de datos
   - Copiar la `DATABASE_URL` proporcionada

4. **Configurar variables de entorno**
```bash
cp sample.env .env
```

Editar el archivo `.env` con tus credenciales:
```env
PORT=3000
DATABASE_URL=postgresql://tu_usuario:tu_password@tu_host/tu_base_datos?sslmode=require
API_KEY=tu_api_key_segura_aqui
JWT_SECRET=tu_jwt_secret_muy_seguro_aqui
TMDB_ACCESS_TOKEN=tu_token_de_tmdb_aqui
```

5. **Crear las tablas en la base de datos**
```bash
# Ejecutar el schema en Neon (usando pgAdmin, DBeaver o psql)
# Archivo: database/schema_postgresql.sql
```

6. **Iniciar el servidor**
```bash
# Modo desarrollo
npm run dev

# Modo producciÃ³n
npm start
```

La API estarÃ¡ disponible en `http://localhost:3000`

---

## ğŸ” AutenticaciÃ³n

### API_KEY (Obligatoria para todas las rutas `/api`)
**TODAS** las rutas protegidas requieren autenticaciÃ³n mediante API_KEY.

**MÃ©todos de envÃ­o:**

**OpciÃ³n 1: Header (Recomendado)**
```bash
curl -H "X-API-KEY: {{api_key}}" http://localhost:3000/api/v1/peliculas
```

**OpciÃ³n 2: Query Parameter**
```bash
curl "http://localhost:3000/api/v1/peliculas?api_key={{api_key}}"
```

### JWT (Para usuarios registrados)
Algunas rutas requieren autenticaciÃ³n de usuario ademÃ¡s de API_KEY.

**Obtener JWT:**
```bash
curl -X POST http://localhost:3000/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"demo@flixfinder.com","password":"demo123"}'
```

**Usar JWT:**
```bash
curl -H "X-API-KEY: {{api_key}}" \
     -H "Authorization: Bearer TU_JWT_TOKEN" \
     http://localhost:3000/api/v1/favorites
```

---

## ğŸ“š Endpoints

### ğŸ”“ Rutas PÃºblicas

#### InformaciÃ³n de la API
```http
GET /
```

#### Health Check
```http
GET /health
```

### ğŸ” AutenticaciÃ³n (sin API_KEY)

#### Registrar usuario
```http
POST /auth/register
Content-Type: application/json

{
  "nombre": "Juan",
  "apellido": "PÃ©rez",
  "email": "juan@email.com",
  "password": "password123",
  "telefono": "1234567890"
}
```

#### Iniciar sesiÃ³n
```http
POST /auth/login
Content-Type: application/json

{
  "email": "juan@email.com",
  "password": "password123"
}
```

#### Obtener perfil (requiere JWT)
```http
GET /auth/profile
Authorization: Bearer <token>
```

#### Actualizar perfil (requiere JWT)
```http
PUT /auth/profile
Authorization: Bearer <token>
Content-Type: application/json

{
  "nombre": "Juan Carlos",
  "telefono": "9876543210"
}
```

### ğŸ¬ PelÃ­culas (requiere API_KEY)

#### Obtener pelÃ­culas populares (TMDb)
```http
GET /api/v1/peliculas
```

#### Buscar pelÃ­culas por tÃ­tulo
```http
GET /api/v1/peliculas/buscar?query=matrix
```

#### Filtrar por gÃ©nero
```http
GET /api/v1/peliculas/generos?genre=28
```

#### Obtener lista de gÃ©neros
```http
GET /api/v1/peliculas/generos
```

#### Obtener pelÃ­cula por ID de TMDb
```http
GET /api/v1/peliculas/:id
```

### ğŸ“º Series (requiere API_KEY)

#### Obtener series populares (TMDb)
```http
GET /api/v1/series?page=1
```

#### Buscar series por nombre
```http
GET /api/v1/series/buscar?query=breaking+bad
```

#### Filtrar por gÃ©nero
```http
GET /api/v1/series/genero?genre=18
```

#### Obtener serie por ID de TMDb
```http
GET /api/v1/series/:id
```

### ğŸ‘¤ Actores (requiere API_KEY)

#### Obtener actores populares (TMDb)
```http
GET /api/v1/actores?page=1&limit=50
```

#### Buscar actores por nombre
```http
GET /api/v1/actores/name?nombre=DiCaprio
```

#### Obtener actor por ID de TMDb
```http
GET /api/v1/actores/:id
```

### ğŸ‘¥ Usuarios (requiere API_KEY)

#### Crear usuario
```http
POST /api/v1/users
Content-Type: application/json

{
  "nombre": "Juan",
  "apellido": "PÃ©rez",
  "email": "juan@email.com",
  "password": "password123",
  "telefono": "1234567890"
}
```

#### Obtener todos los usuarios (paginado)
```http
GET /api/v1/users?page=1&limit=20
```

#### Obtener usuario por ID
```http
GET /api/v1/users/:id
```

#### Actualizar usuario
```http
PUT /api/v1/users/:id
Content-Type: application/json

{
  "nombre": "Juan Carlos",
  "telefono": "9876543210"
}
```

#### Eliminar usuario
```http
DELETE /api/v1/users/:id
```

### â­ Favoritos (requiere API_KEY + JWT)

#### Agregar a favoritos
```http
POST /api/v1/favorites
Authorization: Bearer <token>
Content-Type: application/json

{
  "item_type": "movie",
  "item_id": "550"
}
```
**item_type:** `movie`, `series` o `actor`

#### Obtener favoritos del usuario autenticado
```http
GET /api/v1/favorites
Authorization: Bearer <token>
```

#### Obtener favoritos con detalles
```http
GET /api/v1/favorites/detailed
Authorization: Bearer <token>
```

#### Filtrar favoritos por tipo
```http
GET /api/v1/favorites?type=movie
Authorization: Bearer <token>
```

#### Eliminar favorito por ID
```http
DELETE /api/v1/favorites/:id
Authorization: Bearer <token>
```

### ğŸ“ ReseÃ±as (requiere API_KEY + JWT)

#### Crear reseÃ±a
```http
POST /api/v1/reviews
Authorization: Bearer <token>
Content-Type: application/json

{
  "item_type": "movie",
  "item_id": "550",
  "rating": 9,
  "review_text": "Excelente pelÃ­cula",
  "is_favorite": true
}
```

#### Obtener reseÃ±as del usuario
```http
GET /api/v1/reviews
Authorization: Bearer <token>
```

#### Obtener reseÃ±as con detalles
```http
GET /api/v1/reviews/detailed
Authorization: Bearer <token>
```

#### Actualizar reseÃ±a
```http
PUT /api/v1/reviews/:id
Authorization: Bearer <token>
Content-Type: application/json

{
  "rating": 10,
  "review_text": "Obra maestra"
}
```

#### Eliminar reseÃ±a
```http
DELETE /api/v1/reviews/:id
Authorization: Bearer <token>
```

---

## ğŸ—„ï¸ Base de Datos

### PostgreSQL en Neon

La aplicaciÃ³n utiliza PostgreSQL alojado en Neon (https://neon.tech), un servicio de base de datos en la nube.

### Estructura de Tablas

- **users** - Usuarios registrados con contraseÃ±as hasheadas
- **movies** - Cache de pelÃ­culas de TMDb
- **series** - Cache de series de TMDb
- **actors** - Cache de actores de TMDb
- **favorites** - Favoritos de usuarios (relaciÃ³n polimÃ³rfica)
- **reviews** - ReseÃ±as y calificaciones de usuarios

### Diagrama ER

Ver archivo `docs/DIAGRAMA_ER.md` para el diagrama completo.

### Schema SQL

El schema se encuentra en `database/schema_postgresql.sql`. Ejecutarlo en Neon para crear las tablas.

**Usuario de prueba incluido:**
- Email: `prueba123@prueba.com`
- Password: `Prueba123`

---

## ğŸ“ Estructura del Proyecto

```
API_PPS_CLEMENTE/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ database.js          # ConfiguraciÃ³n PostgreSQL (Neon)
â”‚   â”œâ”€â”€ controllers/
â”‚   â”‚   â”œâ”€â”€ actors.js            # Controladores de actores
â”‚   â”‚   â”œâ”€â”€ authController.js    # AutenticaciÃ³n JWT
â”‚   â”‚   â”œâ”€â”€ books.js             # Libros (OpenLibrary)
â”‚   â”‚   â”œâ”€â”€ favoritesController.js # Favoritos
â”‚   â”‚   â”œâ”€â”€ movies.js            # PelÃ­culas (TMDb)
â”‚   â”‚   â”œâ”€â”€ reviewsController.js # ReseÃ±as
â”‚   â”‚   â”œâ”€â”€ series.js            # Series (TMDb)
â”‚   â”‚   â””â”€â”€ users.js             # Usuarios
â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â””â”€â”€ auth.js              # Middleware API_KEY y JWT
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â””â”€â”€ server.js            # Clase Server principal
â”‚   â””â”€â”€ routes/
â”‚       â”œâ”€â”€ actors.js
â”‚       â”œâ”€â”€ authRoutes.js        # Rutas de autenticaciÃ³n
â”‚       â”œâ”€â”€ books.js
â”‚       â”œâ”€â”€ favorites.js
â”‚       â”œâ”€â”€ movies.js
â”‚       â”œâ”€â”€ reviews.js
â”‚       â”œâ”€â”€ series.js
â”‚       â””â”€â”€ users.js
â”œâ”€â”€ database/
â”‚   â””â”€â”€ schema_postgresql.sql    # Schema de PostgreSQL
â”œâ”€â”€ docs/
â”‚   â””â”€â”€ DIAGRAMA_ER.md           # Diagrama Entidad-RelaciÃ³n
â”œâ”€â”€ public/
â”‚   â””â”€â”€ index.html               # PÃ¡gina de bienvenida
â”œâ”€â”€ .env                         # Variables de entorno (no commitear)
â”œâ”€â”€ sample.env                   # Ejemplo de .env
â”œâ”€â”€ .gitignore
â”œâ”€â”€ app.js                       # Punto de entrada
â”œâ”€â”€ package.json
â”œâ”€â”€ readme.MD                    # Este archivo
```

---

## ğŸ§ª Pruebas con Postman

### Importar ColecciÃ³n

1. Abrir Postman
2. Crear una nueva colecciÃ³n llamada "FlixFinder API"
3. Configurar las variables de entorno

### Variables de Entorno en Postman

Crear un entorno con:
- `base_url`: `http://localhost:3000`
- `api_key`: `tu_api_key_segura_aqui`
- `jwt_token`: (obtenerlo del login)

### Ejemplos de Requests

#### Login y obtener JWT
```http
POST {{base_url}}/auth/login
Content-Type: application/json

{
  "email": "demo@flixfinder.com",
  "password": "demo123"
}
```

#### Obtener pelÃ­culas con API_KEY
```http
GET {{base_url}}/api/v1/peliculas
X-API-KEY: {{api_key}}
```

#### Agregar favorito (requiere JWT)
```http
POST {{base_url}}/api/v1/favorites
X-API-KEY: {{api_key}}
Authorization: Bearer {{jwt_token}}
Content-Type: application/json

{
  "item_type": "movie",
  "item_id": "550"
}
```

---

## ğŸš€ Despliegue

### Opciones de Despliegue

La API puede desplegarse en plataformas como:
- **Render** (recomendado para APIs)
- **Vercel**
- **Heroku**
- **Railway**

### Variables de Entorno en ProducciÃ³n

Asegurarse de configurar en la plataforma:
- `DATABASE_URL` (de Neon)
- `API_KEY` (generar una nueva segura)
- `JWT_SECRET` (generar uno seguro)
- `TMDB_ACCESS_TOKEN`
- `NODE_ENV=production`

### Comandos para Despliegue

```bash
# Instalar dependencias
npm install --production

# Iniciar en producciÃ³n
npm start
```

---

## ğŸ› ï¸ TecnologÃ­as Utilizadas

- **Node.js** - Runtime de JavaScript
- **Express** - Framework web
- **PostgreSQL** - Base de datos relacional
- **Neon** - Servicio de BD en la nube
- **pg** - Cliente PostgreSQL para Node.js
- **bcryptjs** - Hashing de contraseÃ±as
- **jsonwebtoken** - AutenticaciÃ³n JWT
- **axios** - Cliente HTTP para APIs externas
- **cors** - Control de acceso CORS
- **dotenv** - Variables de entorno

---

## ğŸ“ Notas Importantes

### Seguridad
- **API_KEY**: Protege todas las rutas `/api`. Cambiar en producciÃ³n.
- **JWT**: Para autenticaciÃ³n de usuarios. Expira en 24 horas.
- **ContraseÃ±as**: Hasheadas con bcrypt (10 rounds).
- **CORS**: Configurado para Flutter Web.

### Base de Datos
- **Neon**: PostgreSQL serverless. Gratuito hasta ciertos lÃ­mites.
- **Pool de conexiones**: MÃ¡ximo 20 conexiones.
- **Triggers**: Actualizan `updated_at` automÃ¡ticamente.
- **Ãndices**: Optimizados para bÃºsquedas.

### APIs Externas
- **TMDb**: Requiere Access Token (gratuito).
- **Rate limiting**: Respetar lÃ­mites de TMDb.

### Errores Comunes
- **DATABASE_URL**: Verificar SSL mode.
- **API_KEY**: Incluir en headers o query.
- **JWT**: Verificar expiraciÃ³n.

---

## ğŸ‘¥ Desarrollador

- **NicolÃ¡s Clemente** - 
---

## ğŸ“„ Licencia

Proyecto acadÃ©mico - UTN FRBB 2024

---

## ğŸ“ Soporte

Para consultas sobre el proyecto, contactar al profesor SebastiÃ¡n GaÃ±an o al equipo de desarrollo.